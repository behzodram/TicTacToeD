<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Tic-Tac-To o'yini v4.1.1</title>
<link rel="stylesheet" href="style.css" />
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<header id="main-header">
  <div id="currentUsername">---</div>
  <div id="modeToggleWrapper">
    <label for="modeToggle" class="mode-label" title="O'yin rejimini tanlash" aria-label="O'yin rejimini tanlash">Rejim:</label>
    <select id="modeToggle" aria-live="polite" aria-atomic="true" aria-controls="onlinePlayersList">
      <option value="alone" selected>Alone</option>
      <option value="global">Global</option>
    </select>
  </div>
  <button id="settingsToggle" title="Sozlamalar" aria-label="Sozlamalar">&#9881;</button>
</header>

<!-- Login Form -->
<div id="login-container" class="centered-container" style="display:none;">
  <h2>Login / Ro'yxatdan o'tish</h2>
  <input type="text" id="usernameInput" placeholder="Foydalanuvchi ismi" maxlength="15" autocomplete="off" />
  <button id="loginBtn">Kirish</button>
  <div id="loginMsg" class="msg-text"></div>
</div>

<!-- O'yin Bloki -->
<div id="game-container" class="centered-container" style="display:none;">

  <div id="container">
    <div id="playerText">Player 1</div>
    <div class="row">
      <button class="btn" data-index="0"></button>
      <button class="btn" data-index="1"></button>
      <button class="btn" data-index="2"></button>
    </div>
    <div class="row">
      <button class="btn" data-index="3"></button>
      <button class="btn" data-index="4"></button>
      <button class="btn" data-index="5"></button>
    </div>
    <div class="row">
      <button class="btn" data-index="6"></button>
      <button class="btn" data-index="7"></button>
      <button class="btn" data-index="8"></button>
    </div>
  </div>

  <!-- Online userlar va takliflar paneli faqat global rejimda ko'rinadi -->
  <aside id="onlinePanel" class="hidden" aria-live="polite" aria-atomic="true">
    <h3>Onlayn foydalanuvchilar</h3>
    <ul id="onlinePlayersList" tabindex="0" aria-label="Onlayn foydalanuvchilar ro'yxati">
      <!-- userlar JS orqali kiritiladi -->
    </ul>
    <div id="invitationMsg" class="msg-text" aria-live="assertive" aria-atomic="true"></div>
  </aside>

  <!-- "End Game" tugmasi -->
  <button id="endGameBtn" class="hidden" aria-disabled="true" aria-live="polite">End Game</button>
  <div id="endGameNotice" class="msg-text" aria-live="polite"></div>

</div>

<!-- Sozlamalar panel -->
<div id="settingsPanel" class="hidden" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
  <div class="settings-header">
    <h3 id="settingsTitle">Sozlamalar</h3>
    <button id="settingsClose" aria-label="Sozlamalarni yopish">&times;</button>
  </div>

  <label for="newUsernameInput">Yangi username kiriting:</label>
  <input type="text" id="newUsernameInput" maxlength="15" autocomplete="off" placeholder="Yangi username" />
  <button id="changeUsernameBtn">Username-ni o'zgartirish</button>
  <div id="settingsMsg" class="msg-text"></div>
</div>

<!-- Tabriklash oynasi -->
<div id="celebration">
  <h2 id="score-msg"></h2>
  <button id="play-again" onclick="ResetGame()">Play Again</button>
</div>

<!-- Confetti uchun canvas -->
<canvas id="confetti-canvas"></canvas>

<!-- Ovozlar -->
<audio id="winSound" preload="auto" src="https://www.dropbox.com/scl/fi/7h9ob4cd3iknipeqhgf3u/mixkit-achievement-bell-600.wav?rlkey=zyq1auz9urk3vnx70g8x9sp4c&st=iva17nk3&raw=1"></audio>
<audio id="clickSound" preload="auto" src="https://www.dropbox.com/scl/fi/imtc8kle7z9zv8n5s1u97/select-sound-121244.mp3?rlkey=xr90r1doaem833fwntb0po2ms&st=kt25o6un&raw=1"></audio>
<audio id="celebrateSound" preload="auto" src="https://www.dropbox.com/scl/fi/pl2xdyazb467pswzb08tl/mixkit-video-game-treasure-2066.wav?rlkey=shpb4dmiq85u34ipvy4rlv5i4&st=x2dew0lo&raw=1"></audio>

<!-- **Yangi taklif ovozi faqat bir marta** -->
<audio id="invitationSound" preload="auto" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>

<!-- End Game soundlar -->
<audio id="endGameAvailableSound" preload="auto" src="https://actions.google.com/sounds/v1/cartoon/metal_twang.ogg"></audio>
<audio id="endGameUnavailableSound" preload="auto" src="https://actions.google.com/sounds/v1/cartoon/click_2.ogg"></audio>

<!-- Confetti JS -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
  // Firebase konfiguratsiyasi
  const firebaseConfig = {
    apiKey: "AIzaSyC4w_uo2l3-em4VBZ8JcOw1MluvMkUJfqI",
    authDomain: "sololearnballpick.firebaseapp.com",
    databaseURL: "https://sololearnballpick-default-rtdb.firebaseio.com",
    projectId: "sololearnballpick",
    storageBucket: "sololearnballpick.firebasestorage.app",
    messagingSenderId: "117307800410",
    appId: "1:117307800410:web:89095d96ae6d16305f9163",
    measurementId: "G-J2ZHS5LN11"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();

  // DOM elementlar
  const loginContainer = document.getElementById('login-container');
  const gameContainer = document.getElementById('game-container');
  const loginBtn = document.getElementById('loginBtn');
  const usernameInput = document.getElementById('usernameInput');
  const loginMsg = document.getElementById('loginMsg');
  const newUsernameInput = document.getElementById('newUsernameInput');
  const changeUsernameBtn = document.getElementById('changeUsernameBtn');
  const settingsMsg = document.getElementById('settingsMsg');
  const settingsPanel = document.getElementById('settingsPanel');
  const settingsToggle = document.getElementById('settingsToggle');
  const settingsClose = document.getElementById('settingsClose');
  const currentUsernameDisplay = document.getElementById('currentUsername');
  const modeToggle = document.getElementById('modeToggle');
  const onlinePanel = document.getElementById('onlinePanel');
  const onlinePlayersList = document.getElementById('onlinePlayersList');
  const invitationMsg = document.getElementById('invitationMsg');
  const endGameBtn = document.getElementById('endGameBtn');
  const endGameNotice = document.getElementById('endGameNotice');

  // Audio elementlar
  const invitationSound = document.getElementById('invitationSound');
  const endGameAvailableSound = document.getElementById('endGameAvailableSound');
  const endGameUnavailableSound = document.getElementById('endGameUnavailableSound');
  const clickSound = document.getElementById('clickSound');
  const winSound = document.getElementById('winSound');
  const celebrateSound = document.getElementById('celebrateSound');

  // O'yin elementlari
  const btns = Array.from(document.querySelectorAll('.btn'));
  const txtPlayer = document.getElementById('playerText');
  const celebration = document.getElementById('celebration');
  const scoreMsg = document.getElementById('score-msg');
  const playAgainBtn = document.getElementById('play-again');
  const confettiCanvas = document.getElementById('confetti-canvas');

  const STORAGE_KEY = 'ticTacToeUser';

  let round = 1;
  let player = 1;
  let touch = false;

  // Game mode & online data
  let gameMode = 'alone'; // alone or global
  let onlineUsers = {};
  let currentUser = null;
  let currentGameId = null;
  let currentOpponent = null;
  let invitationTimeout = null;
  let gameRef = null;
  let invitationsRef = null;

  // X va O belgilar: taklif qiluvchi X, qabul qiluvchi O
  const PLAYER_X = 'X';
  const PLAYER_O = 'O';

  // O'yin taxtasi holati online uchun
  // Array(9) of '' | 'X' | 'O' reprezentatsiya
  let gameBoard = new Array(9).fill('');

  // ====================== UTILS ========================

  function getUserFromStorage(){
    try {
      return JSON.parse(localStorage.getItem(STORAGE_KEY));
    } catch {
      return null;
    }
  }

  function saveUserToStorage(userObj){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(userObj));
  }

  function validateUsernameFormat(name) {
    const reg = /^[a-zA-Z0-9_-]{2,15}$/;
    return reg.test(name);
  }

  async function isUsernameAvailable(name) {
    name = name.toLowerCase().trim();
    if(!name) return false;
    const snapshot = await db.ref('usernames/' + name).once('value');
    if(snapshot.exists()){
      // Agar bu hozirgi foydalanuvchi username'sa ruxsat beramiz
      if(currentUser && currentUser.username.toLowerCase() === name){
        return true;
      }
      return false;
    }
    return true;
  }

  async function markUsernameOccupied(username, occupy = true){
    username = username.toLowerCase().trim();
    if(!username || !currentUser) return;
    const ref = db.ref('usernames/' + username);
    if(occupy){
      await ref.set({
        uid: currentUser.uid,
        timestamp: Date.now()
      });
    } else {
      await ref.remove();
    }
  }

  // ==================== AUTH ==========================

  async function anonymousLoginAndSaveUsername(username) {
    loginMsg.textContent = '';
    try {
      username = username.trim();
      if(!validateUsernameFormat(username)){
        loginMsg.textContent = 'Username 2-15 belgi, faqat harflar, raqamlar, _ yoki - ishlatilishi mumkin.';
        return false;
      }
      const available = await isUsernameAvailable(username);
      if(!available){
        loginMsg.textContent = 'Ushbu username band. Iltimos boshqasini tanlang.';
        return false;
      }

      if(!auth.currentUser){
        const result = await auth.signInAnonymously();
        if(!result.user) {
          loginMsg.textContent = 'Login amalga oshmadi.';
          return false;
        }
      }

      const prevUser = getUserFromStorage();
      if(prevUser && prevUser.username.toLowerCase() !== username.toLowerCase()){
        await markUsernameOccupied(prevUser.username, false);
      }

      await auth.currentUser.updateProfile({displayName: username});
      saveUserToStorage({username: username, uid: auth.currentUser.uid});
      currentUser = {username, uid: auth.currentUser.uid};
      await markUsernameOccupied(username, true);

      loginContainer.style.display = 'none';
      gameContainer.style.display = 'block';
      updateCurrentUsername(username);
      modeToggle.value = 'alone'; // default alone
      updateGameMode('alone');

      loginMsg.textContent = '';
      settingsMsg.textContent = '';
      newUsernameInput.value = '';
      return true;

    } catch (e) {
      console.error(e);
      loginMsg.textContent = 'Xatolik yuz berdi, qayta urinib ko‘ring.';
      return false;
    }
  }

  auth.onAuthStateChanged(async (user) => {
    if(user){
      const storedUser = getUserFromStorage();
      if(storedUser && storedUser.uid === user.uid){
        currentUser = storedUser;
        loginContainer.style.display = 'none';
        gameContainer.style.display = 'block';
        updateCurrentUsername(currentUser.username);
        modeToggle.value = 'alone'; // default mode
        updateGameMode('alone');
        addCurrentUserToOnline();
        listenOnlineUsers();
        setupInvitationListeners();
      } else {
        loginContainer.style.display = 'block';
        gameContainer.style.display = 'none';
        updateCurrentUsername(null);
      }
    } else {
      loginContainer.style.display = 'block';
      gameContainer.style.display = 'none';
      updateCurrentUsername(null);
      currentUser = null;
      removeCurrentUserFromOnline();
      stopListeningOnlineUsers();
      if(invitationsRef) invitationsRef.off();
      invitationsRef = null;
      if(gameRef) gameRef.off();
      gameRef = null;
      currentGameId = null;
      currentOpponent = null;
    }
  });

  // ==================== ONLINE USERS ====================

  let onlineUsersRef = null;

  function userOnlineData(){
    return {
      username: currentUser.username,
      status: 'available', // 'available' or 'playing'
      lastActive: Date.now(),
      activeGameId: null,
      symbol: null
    };
  }

  function addCurrentUserToOnline(){
    if(!currentUser) return;
    onlineUsersRef = db.ref('onlineUsers/' + currentUser.uid);
    onlineUsersRef.onDisconnect().remove();
    onlineUsersRef.set(userOnlineData());
    onlineUsersRef.update({lastActive: Date.now()});
  }

  function removeCurrentUserFromOnline(){
    if(onlineUsersRef){
      onlineUsersRef.remove();
      onlineUsersRef.off();
      onlineUsersRef = null;
    }
  }

  function listenOnlineUsers(){
    if(!currentUser) return;
    if(window._onlineUsersListener) {
      db.ref('onlineUsers').off('value', window._onlineUsersListener);
      window._onlineUsersListener = null;
    }
    window._onlineUsersListener = db.ref('onlineUsers').on('value', snapshot => {
      const val = snapshot.val() || {};
      onlineUsers = {};
      for(let uid in val){
        if(uid === currentUser.uid) continue;
        if(val[uid].status === 'available' && val[uid].username){
          onlineUsers[uid] = {...val[uid], uid};
        }
      }
      updateOnlineUsersList();
    });
  }

  function stopListeningOnlineUsers(){
    if(window._onlineUsersListener){
      db.ref('onlineUsers').off('value', window._onlineUsersListener);
      window._onlineUsersListener = null;
    }
  }

  // ==================== ONLINE USER UI =================

  function updateOnlineUsersList(){
    onlinePlayersList.innerHTML = '';
    const uids = Object.keys(onlineUsers);
    if(uids.length === 0){
      const li = document.createElement('li');
      li.textContent = 'Onlayn foydalanuvchi topilmadi.';
      li.className = 'no-users';
      onlinePlayersList.appendChild(li);
      return;
    }
    uids.forEach(uid => {
      const user = onlineUsers[uid];
      const li = document.createElement('li');
      li.className = 'online-user';
      li.setAttribute('tabindex', '0');
      li.textContent = user.username;
      li.dataset.uid = uid;

      const inviteBtn = document.createElement('button');
      inviteBtn.textContent = 'Taklif yuborish';
      inviteBtn.className = 'invite-btn';
      inviteBtn.title = `Taklif yuborish ${user.username} ga`;
      inviteBtn.addEventListener('click', () => sendInvitation(uid, user.username));
      li.appendChild(inviteBtn);

      onlinePlayersList.appendChild(li);
    });
  }

  // ================= INVITATIONS & GAME =================

  function setupInvitationListeners(){
    if(!currentUser) return;
    if(invitationsRef) invitationsRef.off();
    invitationsRef = db.ref('invitations/' + currentUser.uid);
    invitationsRef.on('value', snapshot => {
      const inviteData = snapshot.val();
      if(inviteData && inviteData.from && inviteData.gameId){
        handleIncomingInvitation(inviteData.from, inviteData.fromUid, inviteData.gameId);
      } else clearInvitationUI();
    });
  }

  async function sendInvitation(targetUid, targetUsername){
    if(!currentUser) return;
    if(currentGameId){
      alert('Siz hozir o‘yin ichidasiz, boshqa taklif yuborolmaysiz.');
      return;
    }
    invitationMsg.textContent = `Taklif yuborildi ${targetUsername} ga...`;
    // Taklif yuboruvchi X belgisi bilan o'yinni boshlash uchun game yaratish
    const gameKey = db.ref('games').push().key;

    // Yangi o'yin boshlashda taxtani bo'shatish
    gameBoard = new Array(9).fill('');
    round = 1;
    player = 1; // Player X boshlaydi

    // O‘zimiz uchun game ID va symboldan database o'rnatamiz
    currentGameId = gameKey;
    currentOpponent = null; // Qabul qiluvchini keyin beramiz

    // Yuklash, o'yin holatini yaratish: players, board, turn X boshlar
    await db.ref('games/' + gameKey).set({
      players: {
        [currentUser.uid]: {
          username: currentUser.username,
          symbol: PLAYER_X,
        },
        [targetUid]: {
          username: targetUsername,
          symbol: PLAYER_O,
        }
      },
      board: gameBoard,
      turn: PLAYER_X,
      round: 1,
      winner: null,
      status: 'waiting' // waiting, ongoing, finished
    });

    // Taklif ma'lumotini yuborish
    await db.ref('invitations/' + targetUid).set({
      from: currentUser.username,
      fromUid: currentUser.uid,
      gameId: gameKey,
      timestamp: Date.now()
    });

    // Listening to game updates
    subscribeToGame(gameKey);

    // Yangilash UI
    updateOnlineUsersList();
  }

  function handleIncomingInvitation(fromUsername, fromUid, gameId){
    invitationMsg.innerHTML = `<strong>${fromUsername}</strong> sizga taklif yubordi! 
      <button id="acceptInvBtn" aria-label="Taklifni qabul qilish">Qabul qilish</button> 
      <button id="declineInvBtn" aria-label="Taklifni rad etish">Rad etish</button>`;
    invitationSound.currentTime = 0;
    invitationSound.play().catch(() => {});
    document.getElementById('acceptInvBtn').focus();

    document.getElementById('acceptInvBtn').onclick = async () => {
      invitationMsg.textContent = 'Taklif qabul qilindi, o‘yin boshlanmoqda...';
      // Taklif qabul qiluvchi sifatida game o'yinida yangilash
      currentGameId = gameId;
      currentOpponent = {uid: fromUid, username: fromUsername};

      // Board va o'yin holati ko'chiriladi va listening boshlanadi
      subscribeToGame(gameId);

      // User statusni yangilash: playing
      await db.ref('onlineUsers/' + currentUser.uid).update({status: 'playing', activeGameId: gameId});
      // Taklifni olib tashlash
      await db.ref('invitations/' + currentUser.uid).remove();

      // Yangilash UI
      invitationMsg.textContent = '';
      onlinePanel.classList.add('playing');
      showEndGameButton(true);
    };

    document.getElementById('declineInvBtn').onclick = async () => {
      invitationMsg.textContent = 'Taklif rad etildi.';
      await db.ref('invitations/' + currentUser.uid).remove();
      invitationMsg.textContent = '';
    };
  }

  function clearInvitationUI(){
    invitationMsg.textContent = '';
  }

  async function subscribeToGame(gameId){
    if(gameRef) gameRef.off();
    gameRef = db.ref('games/' + gameId);
    gameRef.on('value', snapshot => {
      const data = snapshot.val();
      if(!data){
        // O'yin o'chirilgan yoki tugagan
        resetToAloneMode();
        return;
      }
      if(data.board) {
        gameBoard = data.board;
      }
      round = data.round || 1;
      player = (data.turn === PLAYER_X) ? 1 : 2;
      updateBoardUI();
      updateTurnUI(data.turn);
      if(data.winner) {
        handleGameOver(data.winner);
      } else if(data.status === 'finished') {
        handleGameOver(null); // durang
      }
    });
  }

  function updateBoardUI(){
    btns.forEach((btn, i) => {
      btn.textContent = gameBoard[i] || '';
      btn.dataset.text = gameBoard[i] || '';
      btn.disabled = gameBoard[i] !== '';
    });
  }

  // Turnni yangilash va usernamelarni ko'rsatish
  function updateTurnUI(turn) {
    if(gameMode === 'global' && currentGameId){
      // Player 1 -> X / Player 2 -> O, username bilan almashtirildi
      let playerSymbol = turn;
      let playerUidX = null, playerUidO = null;
      gameRef.child('players').once('value').then(snap => {
        const players = snap.val();
        if(!players) return;
        for(let uid in players){
          if(players[uid].symbol === PLAYER_X) playerUidX = uid;
          if(players[uid].symbol === PLAYER_O) playerUidO = uid;
        }

        let player1Name = players[playerUidX]?.username || 'Player 1';
        let player2Name = players[playerUidO]?.username || 'Player 2';

        if(playerSymbol === PLAYER_X) {
          txtPlayer.textContent = `${player1Name} (X) navbatasiz`;
        } else {
          txtPlayer.textContent = `${player2Name} (O) navbatasiz`;
        }
      });
    } else {
      // Alone rejimida "Player 1" yoki "Player 2"
      txtPlayer.textContent = "Player " + (player || 1);
    }
  }

  // Harakatni amalga oshirish - faqat online o'yinda, belgilangan katakka
  async function makeMoveOnline(index){
    if(gameBoard[index] !== '') return; // bo'sh bo'lishi kerak

    const symbol = (player === 1) ? PLAYER_X : PLAYER_O;

    // Faqat navbatda o'ynash
    const gameSnap = await gameRef.once('value');
    const gameData = gameSnap.val();
    if(!gameData || gameData.status !== 'ongoing' && gameData.status !== 'waiting') return;
    if(gameData.turn !== symbol) return;

    gameBoard[index] = symbol;
    round++;

    // Navbat almashish
    const nextTurn = (symbol === PLAYER_X) ? PLAYER_O : PLAYER_X;

    // G'alaba tekshiruvi (oddiy clientda emas server tarafda qilinsa afzal)
    const winner = checkWinner(gameBoard);

    let updateData = {
      board: gameBoard,
      turn: nextTurn,
      round: round
    };

    if(winner){
      updateData.winner = winner;
      updateData.status = 'finished';
    } else if(round > 9){
      updateData.winner = null; // durang
      updateData.status = 'finished';
    } else {
      updateData.status = 'ongoing';
    }

    await gameRef.update(updateData);
  }

  // Offline "Alone" o'yin uchun klassik kod saqlanadi (btn_OnTouch) (tagi pastda)

  // G'alaba aniqlovchi funksiya - shu yerdan cross platform uchun ishlaydi
  function checkWinner(board){
    const winRows = ["012", "345", "678", "036", "147", "258", "048", "642"];
    for(let row of winRows){
      let a = board[+row[0]];
      let b = board[+row[1]];
      let c = board[+row[2]];
      if(a && a === b && b === c) return a; // X yoki O
    }
    return null;
  }

  function handleGameOver(winnerSymbol) {
    btns.forEach(btn => btn.disabled = true);
    if(winnerSymbol){
      const playerWonName = (winnerSymbol === PLAYER_X) ? getPlayerNameBySymbol(PLAYER_X) : getPlayerNameBySymbol(PLAYER_O);
      scoreMsg.textContent = `${playerWonName} g'alaba qozondi! 🎉`;
      celebrateSound.currentTime = 0;
      celebrateSound.play().catch(() => {});
      launchConfetti();
    } else {
      scoreMsg.textContent = `Durang!`;
      winSound.currentTime = 0;
      winSound.play().catch(() => {});
    }
    celebration.style.display = 'flex';
    showEndGameButton(true);
  }

  function getPlayerNameBySymbol(symbol){
    if(!gameRef) return symbol === PLAYER_X ? 'Player 1' : 'Player 2';
    // Async tekshiruv tugallanganidan keyin qo'llash kerak, ammo hozir etarli
    return symbol === PLAYER_X ? 'Player 1' : 'Player 2';
  }

  // End game tugmasi
  let gameEnded = true;

  function showEndGameButton(show){
    if(show){
      endGameBtn.classList.remove('hidden');
      endGameBtn.setAttribute('aria-disabled', 'false');
      gameEnded = false;
    } else {
      endGameBtn.classList.add('hidden');
      endGameBtn.setAttribute('aria-disabled', 'true');
      gameEnded = true;
      endGameNotice.textContent = '';
    }
  }

  endGameBtn.addEventListener('click', () => {
    if(gameEnded){
      endCurrentGameAndAddToGlobal();
    } else {
      endGameNotice.textContent = "O'yin yakunlanmagan, tugatish uchun yana bosing.";
      endGameUnavailableSound.currentTime = 0;
      endGameUnavailableSound.play().catch(() => {});
    }
  });

  async function endCurrentGameAndAddToGlobal(){
    if(!currentUser) return;
    if(gameRef){
      await gameRef.remove();
      gameRef.off();
      gameRef = null;
    }
    currentGameId = null;
    currentOpponent = null;

    // Statusni update qilish
    await db.ref('onlineUsers/' + currentUser.uid).update({status: 'available', activeGameId: null});
    showEndGameButton(false);
    endGameNotice.textContent = "O'yin tugatildi.";

    endGameAvailableSound.currentTime = 0;
    endGameAvailableSound.play().catch(() => {});

    listenOnlineUsers();
  }

  // ================= GAME BUTTONS ======================

  function btn_OnTouch(e){
    if(touch) return;
    touch = true;

    if(gameMode === 'alone'){
      // Offline klassik o'yin bor
      playClickSound();
      let btn = e.currentTarget;
      player = round % 2 === 1 ? 1 : 2;
      if(btn.dataset.text && btn.dataset.text !== ''){
        touch = false;
        return;
      }
      setTimeout(() => {
        btn.style.opacity = player === 1 ? '0.6' : '1';
        setTimeout(() => btn.style.opacity = '1', 300);
      }, 50);
      SetButton(btn, 'XO'[player - 1]);
      gameBoard[+btn.dataset.index] = 'XO'[player - 1];
      round++;
      setTimeout(()=>{
        CheckWin();
        touch = false;
      }, 220);
    } else if(gameMode === 'global'){
      // Online holatda harakat qilish serverga yozish
      if(!currentGameId){
        invitationMsg.textContent = 'Siz hali o‘yinga ulanmagansiz yoki taklif olmadingiz.';
        touch = false;
        return;
      }
      const btn = e.currentTarget;
      const idx = +btn.dataset.index;
      // O'yin holatini yangilash (online)
      makeMoveOnline(idx).then(() => {
        touch = false;
      }).catch(() => {
        touch = false;
      });
    }
  }

  btns.forEach(btn => {
    btn.dataset.text = '';
    btn.addEventListener('click', btn_OnTouch);
  });

  function playClickSound(){
    clickSound.currentTime = 0;
    clickSound.play().catch(() => {});
  }

  function SetButton(btn, text){
    btn.style.transform = 'rotate(360deg)';
    setTimeout(() => {
      btn.textContent = text;
      btn.style.transform = '';
    }, 100);
    btn.dataset.text = text;
  }

  // Confetti launch
  function launchConfetti() {
    confetti({
      particleCount: 150,
      spread: 90,
      origin: {y: 0.6},
      disableForReducedMotion: true
    });
    const duration = 3000;
    const end = Date.now() + duration;
    (function frame(){
      confetti({particleCount:3, angle:60, spread:55, origin:{x:0}});
      confetti({particleCount:3, angle:120, spread:55, origin:{x:1}});
      if(Date.now() < end) requestAnimationFrame(frame);
    })();
  }

  // Check win offline
  function CheckWin(){
    const winner = checkWinner(gameBoard);
    if(winner){
      EndGame(player);
      if(gameMode === 'global') showEndGameButton(true);
      return;
    }
    if(round > 9){
      EndGame(0);
      if(gameMode === 'global') showEndGameButton(true);
      return;
    }
    txtPlayer.textContent = "Player " + player;
  }

  function EndGame(winner){
    btns.forEach(btn => btn.disabled = true);
    if(winner){
      scoreMsg.textContent = `Player ${winner} won! 🎉`;
      celebrateSound.currentTime = 0;
      celebrateSound.play().catch(() => {});
      launchConfetti();
    } else {
      scoreMsg.textContent = "It's a draw!";
      winSound.currentTime = 0;
      winSound.play().catch(() => {});
    }
    celebration.style.display = 'flex';
  }

  function ResetGame(){
    celebration.style.display = 'none';
    btns.forEach(btn => {
      btn.disabled = false;
      SetButton(btn, '');
    });
    round = 1;
    player = 1;
    touch = false;
    gameBoard = new Array(9).fill('');
    txtPlayer.textContent = gameMode === 'global' && currentGameId ? currentUser.username + " (X), navbat" : "Player 1";
    if(gameMode === 'global'){
      showEndGameButton(false);
    }
  }

  // ================= SETTING VARIABLES AND LISTENERS ================

  function updateCurrentUsername(name){
    currentUsernameDisplay.textContent = name || '---';
  }

  modeToggle.addEventListener('change', e => {
    updateGameMode(e.target.value);
  });

  function updateGameMode(newMode){
    gameMode = newMode || 'alone';

    if(gameMode === 'alone'){
      onlinePanel.classList.add('hidden');
      currentGameId = null;
      currentOpponent = null;
      showEndGameButton(false);
      invitationMsg.textContent = '';
      endGameNotice.textContent = '';
      resetBoardForAlone();
    } else if(gameMode === 'global'){
      onlinePanel.classList.remove('hidden');
      listenOnlineUsers();
      setupInvitationListeners();
    }
  }

  function resetBoardForAlone(){
    gameBoard = new Array(9).fill('');
    round = 1;
    player = 1;
    updateBoardUI();
    txtPlayer.textContent = "Player 1";
    celebration.style.display = "none";
    showEndGameButton(false);
  }

  settingsToggle.addEventListener('click', () => toggleSettingsPanel(true));
  settingsClose.addEventListener('click', () => toggleSettingsPanel(false));

  changeUsernameBtn.addEventListener('click', async () => {
    const newName = newUsernameInput.value.trim();
    if(newName.length < 2) {
      settingsMsg.textContent = 'Yangi username kamida 2 ta belgidan iborat bo‘lishi kerak.';
      return;
    }
    settingsMsg.textContent = "Tekshirilmoqda...";
    const updated = await saveUsernameToUserProfile(newName);
    if(updated){
      toggleSettingsPanel(false);
      newUsernameInput.value = '';
    }
  });

  function toggleSettingsPanel(show) {
    if(show){
      settingsPanel.classList.remove('hidden');
      settingsPanel.classList.add('visible');
    } else {
      settingsPanel.classList.remove('visible');
      settingsPanel.classList.add('hidden');
      settingsMsg.textContent = '';
      newUsernameInput.value = '';
    }
  }

  async function saveUsernameToUserProfile(username) {
    username = username.trim();
    settingsMsg.textContent = '';

    if(!validateUsernameFormat(username)){
      settingsMsg.textContent = 'Username 2-15 belgi, faqat harflar, raqamlar, _ yoki - ishlatilishi mumkin.';
      return false;
    }

    const available = await isUsernameAvailable(username);
    if(!available){
      settingsMsg.textContent = 'Ushbu username band. Boshqasini tanlang.';
      return false;
    }

    try {
      const storedUser = getUserFromStorage();
      if(!storedUser) {
        settingsMsg.textContent = "Siz oldin tizimga kirmagansiz.";
        return false;
      }

      if(storedUser.username.toLowerCase() !== username.toLowerCase()) {
        await markUsernameOccupied(storedUser.username, false);
      }

      await auth.currentUser.updateProfile({displayName: username});
      saveUserToStorage({username: username, uid: auth.currentUser.uid});
      currentUser.username = username;
      await markUsernameOccupied(username, true);

      updateCurrentUsername(username);
      settingsMsg.textContent = "Username muvaffaqiyatli o'zgartirildi.";
      return true;

    } catch(e) {
      console.error(e);
      settingsMsg.textContent = 'Username o\'zgartirishda xatolik yuz berdi.';
      return false;
    }
  }
</script>
</body>
</html>
